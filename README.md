# 이벤트 관리 서비스

## 요구사항

> 목표 : NestJS + MSA + MongoDB 기반으로 이벤트 보상 시스템 3개의 서버 구축

> 주요 기능 : 이벤트 생성, 보상 정의, 유저 보상 요청, 관리자 및 감사자 확인 기능

### 서버 구성

1. Gateway Server - 모든 API의 진입점, 인증 및 권한 검사

   - NestJS의 `@nestjs/passport` `AuthGuard` `RolesGuard` 사용할 것

2. Auth Server - 유저 정보 관리, 로그인, 역할 관리, JWT 발급
3. Event Server - 이벤트 생성, 보상 정의, 보상 요청 관리, 지급 상태 저장
   - 이벤트 조회 및 등록
   - 보상 조회 및 등록
   - 유저 보상 요청
   - 보상 요청 내역 확인

## 프로젝트 실행 방법

#### docker-compse 실행 및 각 서비스 빌드

```bash
# 컨테이너 실행 및 빌드 명령어
docker-compose up --build

# 혹은
docker compose up --build

# 컨테이너 종료
docker-compse down
```

#### 프로젝트 버전 관리

```
node - 18 (고정)
nest - 최신
DB - MongoDB
인증 - JWT
배포/실행 - docker + docker-compose
언어 - TS
```

## 프로젝트 일지

### 1일차

- nestjs 전역 설치

```bash
# nestjs cli 전역 설치
npm install -global @nestjs/cli@latest
```

- nestJS 사용 명령어

```bash
# gateway 서비스 구축
nest new gateway

# gateway 라이브러리 설치
npm install @nestjs/microservices @nestjs/passport passport passport-jwt jsonwebtoken bcrypt

# auth 서비스 구축
nest new auth
npm install @nestjs/microservices

# event 서비스 구축
nest new event
npm install @nestjs/microservices
```

### 2일차

- MongoDB 설치

```bash
# 로컬 docker를 통한 mongodb 설치
docker run -d --name mongodb -p 27017:27017 -e MONGO_INITDB_ROOT_USERNAME=root -e MONGO_INITDB_ROOT_PASSWORD=1234 mongo

# @nestjs/mongoose: NestJS용 Mongoose 모듈
npm install @nestjs/mongoose mongoose
```

- 비밀번호 암호화
  - 유저 등록시
  - 로그인 시

```bash
# nest bcrypt
npm i bcrypt
npm i -D @types/bcrypt
```

### 3일차

**이벤트 및 보상 CRUD**

#### 이벤트

- 이벤트 등록(CREATE)

  - 등록은 관리자(ADMIN)와 운영자(OPERATOR)가 할 수 있다.
  - 그 외 권한을 가진 자가 접근 시 에러 발생
  - 이벤트 이름, 설명, 조건, 활성화상태, 시작일자, 끝일자 로 구성되어 있다
  - 같은 일자의 동일한 이벤트는 등록될 수 없다.
    - 단, 같은 이벤트가 다른일자에는 등록이 될 수 있다

- 이벤트 조회(READ)

  - 이벤트 목록, 상세정보를 조회할 수 있어야 한다.
    - 전체 목록 조회 시 빈 배열이 반환 된다.
    - 상세 정보 조회 시 id값에 따른 정보가 없다면 에러가 발생한다.
  - 권한은 사용자, 운영자, 관리자가 할 수 있다.

- 이벤트 수정(UPDATE)

- 이벤트 삭제(DELETE)
  - 등록과 마찬가지로 운영자와 관리자만 삭제할 수 있다.
  - 존재하지 않는 이벤트의 id값으로 요청 시 에러가 발생한다.

#### 보상

- 보상 등록(CREATE)
  - 등록은 운영자와 관리자가 가능하다.
  - 연결하고자 하는 이벤트 ID값을 담아 요청해야한다.
  - 보상 항목은 여러개가 될 수 있다
    - 추후 추가, 삭제, 정정 할 수 있다.
- 보상 조회(READ)

  - 조회는 전체목록, 상세 정보를 조회 할 수 있다.
  - 조회 시 연결되어 있는 이벤트의 ID값을 조회 할 수 있다.
    - 해당 id값으로 어떤 이벤트인지 나타내야 함

- 보상 수정(UPDATE)

  - 권한은 운영자와 관리자가 가능
  - 보상에 대한 항목을 변경하는 것이 아닌 보상 정보를 수정
  - 존재하지 않는 보상에 대한 정보를 수정 요청 시 에러 발생

- 보상 삭제(DELETE)

  - 권한은 운영자와 관리자가 가능
  - 존재 하지 않는 보상에 대한 정보를 삭제 요청 시 에러 발생

- 보상 항목 추가

  - 권한은 운영자와 관리자가 가능
  - 존재하는 보상에 대한 항목들을 추가
  - 존재하지 않는 보상에 대한 항목 추가 시 에러가 발생

- 보상 항목 삭제

  - 권한은 운영자와 관리자가 가능
  - 존재하는 보상에 대한 항목들을 삭제
  - 존재하지 않는 보상에 대한 항목 삭제 시 에러가 발생

- 보상 항목 정정
  - 권한은 운영자와 관리자가 가능
  - 존재하는 보상에 대한 항목들을 정정
  - 존재하지 않는 보상에 대한 항목 정정 시 에러가 발생

### 4일차 (마지막)

- 기능 구현을 위한 이벤트는 다음과 같다

  1. **회원가입 이후 첫 로그인 성공 !**

  - 사용자가 회원가입 이후 첫 로그인 시 최초로 1회 보상을 지급 받을 수 있다.
    - 사용자 정보에 첫 로그인을 했는지 안했지에 대한 속성값을 추가해서 저장
    - 이후 보상 요청 검증 시 확인하여 보상 지급

  2. **회원가입 시 추천인 코드를 입력하라!**

     - 회원가입 시 모든 이용자들을 추천인 코드를 생성 받는다
     - 이에 기존 이용자들 중 어느 한명의 추천인 코드를 입력하면 가입 유저는 해당 이벤트에 충족된다
     - 추천인 코드를 입력 했는지 안했는지에 대한 정보는 회원가입 시 입력된 정보로 판단하여 저장한다

- 사용자의 보상 요청 기능 추가

  1. 사용자가 로그인을 실시
  2. 로그인 된 사용자가 이벤트 목록을 조회
  3. 조회된 목록 중 특정 이벤트의 대한 보상 요청을 요청
  4. 시스템 내부(서버)에서 해당 검증을 실시

     - 이벤트 서비스(서버)에서 요청된 사용자의 JWT값을 검증하여 `userId`값으로 유저 서비스(서버)로 사용자 정보를 조회
     - 조회된 사용자 정보와 이벤트 정보로 지급 내역을 확인 (이중 지급 방지)
     - 특정 이벤트에 대한 충족 여부를 확인
       - 이벤트 별로 상태값과 시작일자, 끝일자를 요청시 현재시간이랑 비교
     - 정상적으로 충족 대상이라면 지급 내역을 저장
     - 이벤트 미충족시 해당 내용 저장 (요구사항 - 상태 실패에 대한 정보 저장)

  5. 지급된 내역을 응답

- 보상 지급 내역 조회 기능 추가
  - 권한은 운영자를 제외한 모두에게 있지만, 조회 조건이 다르다
    - 특정 사용자는 본인이 받은 지급 내역만 받을 수 있다
    - 그 외 관리자, 감시자는 전체 보상 이력을 조회할 수 있다

#### 추가 및 보강 기능 구현 목록

- 보상 이력 조회 필터링 기능 (이벤트별, 상태별)

- 이벤트 수정 기능

  - 테스트하지 못해 주석 처리

- 데이터베이스 스키마/ERD 관리 미흡

  - 유저정보와 이벤트, 보상, 지급내역 스키마들 간의 관계 미흡
  - 스키마들 `SELECT` (조회)시 전체 속성값 모두 조회 (필요한 값만 불러오는 작업 미흡)
  - 목록 조회 시 페이지네이션, 필터 등 기능 누락

- MSA, 모노레포 등 구조적 설계 미흡 또는 통일성 부족

  - 공통 라이브러리 구조
    - 별도의 `공통 라이브러리(패키지, 예: @myorg/common 또는 libs/common)`로 분리해서
      각 서비스가 npm/yarn workspace 등으로 의존성 추가, 서비스별 도메인 모델, DB 스키마, 비즈니스 로직 등은 각 서비스 내부에서만 존재

- 환경 변수 설정 (.env)

- 테스트 코드 부족

- API 문서, ERD, 시스템 구조

- 주기적인 코드 정리 및 리뷰
